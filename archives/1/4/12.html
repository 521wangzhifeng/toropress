<!DOCTYPE html>
<html lang="zh-CN">
    <head>  
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
        
    <meta name="description" content="toropress" />
    <meta name="keywords" content="toropress" />
    <meta name="author" content="insion"/>
    
    <title>Toropress</title>
  <link href='http://fonts.googleapis.com/css?family=Droid+Sans:400,700' rel='stylesheet' type='text/css'>
  
  
  <link href="/static/themes/nannie/css/bootstrap.css" rel="stylesheet">
  <link rel="stylesheet" href="/static/themes/nannie/css/font-awesome.css">
        
  <link href="/static/themes/nannie/css/style.css" rel="stylesheet">
  <link href="/static/themes/nannie/css/bootstrap-responsive.css" rel="stylesheet">
  

  
    
    <link rel="shortcut icon" href="/static/ico/favicon.ico">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="/static/ico/apple-touch-icon-114-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="/static/ico/apple-touch-icon-72-precomposed.png">
    <link rel="apple-touch-icon-precomposed" href="/static/ico/apple-touch-icon-57-precomposed.png">

<style type="text/css">.recentcomments a{display:inline !important;padding:0 !important;margin:0 !important;}</style>
   
</head>

<body>


<header>
   <div class="container">
      <div class="row">
         <div class="span4">
            <div class="logo">
               
               <a href="/"><h1>Insion.<span class="color">Co</span></h1></a>
               <p class="lmeta">Toropress，又一个Toropress..</p>
            </div>
         </div>
         
      </div>
   </div>
</header>

         <div class="navbar">
            <div class="navbar-inner">
               <div class="container">
                  <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                     <span>菜单</span>
                  </a>
                  <div class="nav-collapse collapse">
                      <ul class="nav">
                        <ul id="menu-menu" class="nav">
                          <li id="menu-item-30" class="menu-item menu-item-type-custom menu-item-object-custom current-menu-item current_page_item menu-item-home menu-item-30"><a href="/">首页</a></li>
                        
                          
                            <li class="menu-item"><a href="/category/1">代码</a></li>
                          
                            <li class="menu-item"><a href="/category/2"> 笔记</a></li>
                          
                            <li class="menu-item"><a href="/category/3">文学</a></li>
                          
                        
                        </ul>
                      </ul>
                  </div>
               </div>
            </div>
         </div>



<div class="content">
   <div class="container">
      <div class="row">
         <div class="span8">
          
<h3 style="display:none"><span>Post</span></h3>
<div class="posts">
                                    
               <div class="entry" id="post-27">
                  <div class="matter">
                  
                     <h2> Golang图片验证码例子</h2>
                     
                     <div class="meta"><i class="icon-calendar"></i> March 14 , 2013 at 19:45 am - <i class="icon-folder-open"></i> <a href="/user/0/" title="View all posts in Etiam" rel="category tag">Insion</a> - <i class="icon-comment"></i> <a href="http://responsivewebinc.com/nannie/suspendisse-eget-lorem-dui/#comments" title="Comment on Suspendisse eget lorem dui">0 Comments</a></div>
                     
                     <div><p>package main<br />
import (<br />
&nbsp;&nbsp; &nbsp;&quot;image&quot;<br />
&nbsp;&nbsp; &nbsp;&quot;image/color&quot;<br />
&nbsp;&nbsp; &nbsp;&quot;image/png&quot;<br />
&nbsp;&nbsp; &nbsp;&quot;io&quot;<br />
&nbsp;&nbsp; &nbsp;&quot;net/http&quot;<br />
&nbsp;&nbsp; &nbsp;&quot;math/rand&quot;<br />
&nbsp;&nbsp; &nbsp;crand &quot;crypto/rand&quot;<br />
&nbsp;&nbsp; &nbsp;&quot;time&quot;<br />
&nbsp;&nbsp; &nbsp;&quot;fmt&quot;<br />
&nbsp;&nbsp; &nbsp;&quot;strconv&quot;<br />
)<br />
const (<br />
&nbsp;&nbsp; &nbsp;stdWidth = 100<br />
&nbsp;&nbsp; &nbsp;stdHeight = 40<br />
&nbsp;&nbsp; &nbsp;maxSkew = 2<br />
)</p>

<p>const (<br />
&nbsp;&nbsp; &nbsp;fontWidth &nbsp;= 5<br />
&nbsp;&nbsp; &nbsp;fontHeight = 8<br />
&nbsp;&nbsp; &nbsp;blackChar &nbsp;= 1<br />
)</p>

<p>var font = [][]byte{<br />
&nbsp;&nbsp; &nbsp;{ // 0<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;0, 1, 1, 1, 0,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;1, 0, 0, 0, 1,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;1, 0, 0, 0, 1,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;1, 0, 0, 0, 1,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;1, 0, 0, 0, 1,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;1, 0, 0, 0, 1,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;1, 0, 0, 0, 1,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;0, 1, 1, 1, 0,<br />
&nbsp;&nbsp; &nbsp;},<br />
&nbsp;&nbsp; &nbsp;{ // 1<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;0, 0, 1, 0, 0,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;0, 1, 1, 0, 0,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;1, 0, 1, 0, 0,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;0, 0, 1, 0, 0,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;0, 0, 1, 0, 0,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;0, 0, 1, 0, 0,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;0, 0, 1, 0, 0,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;1, 1, 1, 1, 1,<br />
&nbsp;&nbsp; &nbsp;},<br />
&nbsp;&nbsp; &nbsp;{ // 2<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;0, 1, 1, 1, 0,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;1, 0, 0, 0, 1,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;0, 0, 0, 0, 1,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;0, 0, 0, 1, 1,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;0, 1, 1, 0, 0,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;1, 0, 0, 0, 0,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;1, 0, 0, 0, 0,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;1, 1, 1, 1, 1,<br />
&nbsp;&nbsp; &nbsp;},<br />
&nbsp;&nbsp; &nbsp;{ // 3<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;1, 1, 1, 1, 0,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;0, 0, 0, 0, 1,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;0, 0, 0, 1, 0,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;0, 1, 1, 1, 0,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;0, 0, 0, 1, 0,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;0, 0, 0, 0, 1,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;0, 0, 0, 0, 1,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;1, 1, 1, 1, 0,<br />
&nbsp;&nbsp; &nbsp;},<br />
&nbsp;&nbsp; &nbsp;{ // 4<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;1, 0, 0, 1, 0,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;1, 0, 0, 1, 0,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;1, 0, 0, 1, 0,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;1, 0, 0, 1, 0,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;1, 1, 1, 1, 1,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;0, 0, 0, 1, 0,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;0, 0, 0, 1, 0,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;0, 0, 0, 1, 0,<br />
&nbsp;&nbsp; &nbsp;},<br />
&nbsp;&nbsp; &nbsp;{ // 5<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;1, 1, 1, 1, 1,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;1, 0, 0, 0, 0,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;1, 0, 0, 0, 0,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;1, 1, 1, 1, 0,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;0, 0, 0, 0, 1,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;0, 0, 0, 0, 1,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;0, 0, 0, 0, 1,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;1, 1, 1, 1, 0,<br />
&nbsp;&nbsp; &nbsp;},<br />
&nbsp;&nbsp; &nbsp;{ // 6<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;0, 0, 1, 1, 1,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;0, 1, 0, 0, 0,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;1, 0, 0, 0, 0,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;1, 1, 1, 1, 0,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;1, 0, 0, 0, 1,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;1, 0, 0, 0, 1,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;1, 0, 0, 0, 1,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;0, 1, 1, 1, 0,<br />
&nbsp;&nbsp; &nbsp;},<br />
&nbsp;&nbsp; &nbsp;{ // 7<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;1, 1, 1, 1, 1,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;0, 0, 0, 0, 1,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;0, 0, 0, 0, 1,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;0, 0, 0, 1, 0,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;0, 0, 1, 0, 0,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;0, 1, 0, 0, 0,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;0, 1, 0, 0, 0,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;0, 1, 0, 0, 0,<br />
&nbsp;&nbsp; &nbsp;},<br />
&nbsp;&nbsp; &nbsp;{ // 8<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;0, 1, 1, 1, 0,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;1, 0, 0, 0, 1,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;1, 0, 0, 0, 1,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;0, 1, 1, 1, 0,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;1, 0, 0, 0, 1,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;1, 0, 0, 0, 1,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;1, 0, 0, 0, 1,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;0, 1, 1, 1, 0,<br />
&nbsp;&nbsp; &nbsp;},<br />
&nbsp;&nbsp; &nbsp;{ // 9<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;0, 1, 1, 1, 0,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;1, 0, 0, 0, 1,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;1, 0, 0, 0, 1,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;1, 1, 0, 0, 1,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;0, 1, 1, 1, 1,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;0, 0, 0, 0, 1,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;0, 0, 0, 0, 1,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;1, 1, 1, 1, 0,<br />
&nbsp;&nbsp; &nbsp;},<br />
}</p>

<p>type Image struct {<br />
&nbsp;&nbsp; &nbsp;*image.NRGBA<br />
&nbsp;&nbsp; &nbsp;color &nbsp;&nbsp; &nbsp;*color.NRGBA<br />
&nbsp;&nbsp; &nbsp;width &nbsp;&nbsp; &nbsp;int &nbsp;//a digit width<br />
&nbsp;&nbsp; &nbsp;height &nbsp;&nbsp; &nbsp;int &nbsp;//a digit height<br />
&nbsp;&nbsp; &nbsp;dotsize int<br />
}<br />
func init(){<br />
&nbsp;&nbsp; &nbsp;rand.Seed(int64(time.Second))<br />
}</p>

<p>func NewImage(digits []byte, width, height int) *Image {<br />
&nbsp;&nbsp; &nbsp;img := new(Image)<br />
&nbsp;&nbsp; &nbsp;r := image.Rect(img.width, img.height, stdWidth, stdHeight)<br />
&nbsp;&nbsp; &nbsp;img.NRGBA = image.NewNRGBA(r)<br />
&nbsp;&nbsp; &nbsp;<br />
&nbsp;&nbsp; &nbsp;img.color = &amp;color.NRGBA{<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;uint8(rand.Intn(129)),<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;uint8(rand.Intn(129)),<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;uint8(rand.Intn(129)),<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;0xFF,<br />
&nbsp;&nbsp; &nbsp;}<br />
&nbsp;&nbsp; &nbsp;// Draw background (10 random circles of random brightness)<br />
&nbsp;&nbsp; &nbsp;img.calculateSizes(width, height, len(digits))<br />
&nbsp;&nbsp; &nbsp;img.fillWithCircles(10, img.dotsize)</p>

<p>&nbsp;&nbsp; &nbsp;maxx := width - (img.width+img.dotsize)*len(digits) - img.dotsize<br />
&nbsp;&nbsp; &nbsp;maxy := height - img.height - img.dotsize*2</p>

<p>&nbsp;&nbsp; &nbsp;x := rnd(img.dotsize*2, maxx)<br />
&nbsp;&nbsp; &nbsp;y := rnd(img.dotsize*2, maxy)</p>

<p>&nbsp;&nbsp; &nbsp;// Draw digits.<br />
&nbsp;&nbsp; &nbsp;for _, n := range digits {<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;img.drawDigit(font[n], x, y)<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;x += img.width + img.dotsize<br />
&nbsp;&nbsp; &nbsp;}</p>

<p>&nbsp;&nbsp; &nbsp;// Draw strike-through line.<br />
&nbsp;&nbsp; &nbsp;img.strikeThrough()<br />
&nbsp;&nbsp; &nbsp;return img<br />
}</p>

<p>func (img *Image) WriteTo(w io.Writer) (int64, error) {<br />
&nbsp;&nbsp; &nbsp;return 0, png.Encode(w, img)<br />
}</p>

<p>func (img *Image) calculateSizes(width, height, ncount int) {</p>

<p>&nbsp;&nbsp; &nbsp;// Goal: fit all digits inside the image.<br />
&nbsp;&nbsp; &nbsp;var border int<br />
&nbsp;&nbsp; &nbsp;if width &gt; height {<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;border = height / 5<br />
&nbsp;&nbsp; &nbsp;} else {<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;border = width / 5<br />
&nbsp;&nbsp; &nbsp;}<br />
&nbsp;&nbsp; &nbsp;// Convert everything to floats for calculations.<br />
&nbsp;&nbsp; &nbsp;w := float64(width - border*2) //268<br />
&nbsp;&nbsp; &nbsp;h := float64(height - border*2) //48<br />
&nbsp;&nbsp; &nbsp;// fw takes into account 1-dot spacing between digits.</p>

<p>&nbsp;&nbsp; &nbsp;fw := float64(fontWidth) + 1 //6</p>

<p>&nbsp;&nbsp; &nbsp;fh := float64(fontHeight) &nbsp;//8<br />
&nbsp;&nbsp; &nbsp;nc := float64(ncount) &nbsp;//7</p>

<p>&nbsp;&nbsp; &nbsp;// Calculate the width of a single digit taking into account only the<br />
&nbsp;&nbsp; &nbsp;// width of the image.<br />
&nbsp;&nbsp; &nbsp;nw := w / nc //38<br />
&nbsp;&nbsp; &nbsp;// Calculate the height of a digit from this width.<br />
&nbsp;&nbsp; &nbsp;nh := nw * fh / fw //51</p>

<p>&nbsp;&nbsp; &nbsp;// Digit too high?</p>

<p>&nbsp;&nbsp; &nbsp;if nh &gt; h {<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;// Fit digits based on height.<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;nh = h //nh = 44<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;nw = fw / fh * nh<br />
&nbsp;&nbsp; &nbsp;}<br />
&nbsp;&nbsp; &nbsp;// Calculate dot size.<br />
&nbsp;&nbsp; &nbsp;img.dotsize = int(nh / fh)<br />
&nbsp;&nbsp; &nbsp;// Save everything, making the actual width smaller by 1 dot to account<br />
&nbsp;&nbsp; &nbsp;// for spacing between digits.<br />
&nbsp;&nbsp; &nbsp;img.width = int(nw)<br />
&nbsp;&nbsp; &nbsp;img.height = int(nh) - img.dotsize<br />
}</p>

<p>func (img *Image) fillWithCircles(n, maxradius int) {<br />
&nbsp;&nbsp; &nbsp;color := img.color<br />
&nbsp;&nbsp; &nbsp;maxx := img.Bounds().Max.X<br />
&nbsp;&nbsp; &nbsp;maxy := img.Bounds().Max.Y<br />
&nbsp;&nbsp; &nbsp;for i := 0; i &lt; n; i++ {<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;setRandomBrightness(color, 255)<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;r := rnd(1, maxradius)<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;img.drawCircle(color, rnd(r, maxx-r), rnd(r, maxy-r), r)<br />
&nbsp;&nbsp; &nbsp;}<br />
}</p>

<p>func (img *Image) drawHorizLine(color color.Color, fromX, toX, y int) {<br />
&nbsp;&nbsp; &nbsp;for x := fromX; x &lt;= toX; x++ {<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;img.Set(x, y, color)<br />
&nbsp;&nbsp; &nbsp;}<br />
}</p>

<p>func (img *Image) drawCircle(color color.Color, x, y, radius int) {<br />
&nbsp;&nbsp; &nbsp;f := 1 - radius<br />
&nbsp;&nbsp; &nbsp;dfx := 1<br />
&nbsp;&nbsp; &nbsp;dfy := -2 * radius<br />
&nbsp;&nbsp; &nbsp;xx := 0<br />
&nbsp;&nbsp; &nbsp;yy := radius</p>

<p>&nbsp;&nbsp; &nbsp;img.Set(x, y+radius, color)<br />
&nbsp;&nbsp; &nbsp;img.Set(x, y-radius, color)<br />
&nbsp;&nbsp; &nbsp;img.drawHorizLine(color, x-radius, x+radius, y)</p>

<p>&nbsp;&nbsp; &nbsp;for xx &lt; yy {<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;if f &gt;= 0 {<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;yy--<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;dfy += 2<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;f += dfy<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;xx++<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;dfx += 2<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;f += dfx<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;img.drawHorizLine(color, x-xx, x+xx, y+yy)<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;img.drawHorizLine(color, x-xx, x+xx, y-yy)<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;img.drawHorizLine(color, x-yy, x+yy, y+xx)<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;img.drawHorizLine(color, x-yy, x+yy, y-xx)<br />
&nbsp;&nbsp; &nbsp;}<br />
}</p>

<p>func (img *Image) strikeThrough() {<br />
&nbsp;&nbsp; &nbsp;r := 0<br />
&nbsp;&nbsp; &nbsp;maxx := img.Bounds().Max.X<br />
&nbsp;&nbsp; &nbsp;maxy := img.Bounds().Max.Y<br />
&nbsp;&nbsp; &nbsp;y := rnd(maxy/3, maxy-maxy/3)<br />
&nbsp;&nbsp; &nbsp;for x := 0; x &lt; maxx; x += r {<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;r = rnd(1, img.dotsize/3)<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;y += rnd(-img.dotsize/2, img.dotsize/2)<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;if y &lt;= 0 || y &gt;= maxy {<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;y = rnd(maxy/3, maxy-maxy/3)<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;img.drawCircle(img.color, x, y, r)<br />
&nbsp;&nbsp; &nbsp;}<br />
}</p>

<p>func (img *Image) drawDigit(digit []byte, x, y int) {<br />
&nbsp;&nbsp; &nbsp;skf := rand.Float64() * float64(rnd(-maxSkew, maxSkew))<br />
&nbsp;&nbsp; &nbsp;xs := float64(x)<br />
&nbsp;&nbsp; &nbsp;minr := img.dotsize / 2 &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; // minumum radius<br />
&nbsp;&nbsp; &nbsp;maxr := img.dotsize/2 + img.dotsize/4 // maximum radius<br />
&nbsp;&nbsp; &nbsp;y += rnd(-minr, minr)<br />
&nbsp;&nbsp; &nbsp;for yy := 0; yy &lt; fontHeight; yy++ {<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;for xx := 0; xx &lt; fontWidth; xx++ {<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;if digit[yy*fontWidth+xx] != blackChar {<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;continue<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;// Introduce random variations.<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;or := rnd(minr, maxr)<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;ox := x + (xx * img.dotsize) + rnd(0, or/2)<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;oy := y + (yy * img.dotsize) + rnd(0, or/2)</p>

<p>&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;img.drawCircle(img.color, ox, oy, or)<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;xs += skf<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;x = int(xs)<br />
&nbsp;&nbsp; &nbsp;}<br />
}</p>

<p>func setRandomBrightness(c *color.NRGBA, max uint8) {<br />
&nbsp;&nbsp; &nbsp;minc := min3(c.R, c.G, c.B)<br />
&nbsp;&nbsp; &nbsp;maxc := max3(c.R, c.G, c.B)<br />
&nbsp;&nbsp; &nbsp;if maxc &gt; max {<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;return<br />
&nbsp;&nbsp; &nbsp;}<br />
&nbsp;&nbsp; &nbsp;n := rand.Intn(int(max-maxc)) - int(minc)<br />
&nbsp;&nbsp; &nbsp;c.R = uint8(int(c.R) + n)<br />
&nbsp;&nbsp; &nbsp;c.G = uint8(int(c.G) + n)<br />
&nbsp;&nbsp; &nbsp;c.B = uint8(int(c.B) + n)<br />
}</p>

<p>func min3(x, y, z uint8) (o uint8) {<br />
&nbsp;&nbsp; &nbsp;o = x<br />
&nbsp;&nbsp; &nbsp;if y &lt; o {<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;o = y<br />
&nbsp;&nbsp; &nbsp;}<br />
&nbsp;&nbsp; &nbsp;if z &lt; o {<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;o = z<br />
&nbsp;&nbsp; &nbsp;}<br />
&nbsp;&nbsp; &nbsp;return<br />
}</p>

<p>func max3(x, y, z uint8) (o uint8) {<br />
&nbsp;&nbsp; &nbsp;o = x<br />
&nbsp;&nbsp; &nbsp;if y &gt; o {<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;o = y<br />
&nbsp;&nbsp; &nbsp;}<br />
&nbsp;&nbsp; &nbsp;if z &gt; o {<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;o = z<br />
&nbsp;&nbsp; &nbsp;}<br />
&nbsp;&nbsp; &nbsp;return<br />
}</p>

<p>// rnd returns a random number in range [from, to].<br />
func rnd(from, to int) int {<br />
&nbsp;&nbsp; &nbsp;//println(to+1-from)<br />
&nbsp;&nbsp; &nbsp;return rand.Intn(to+1-from) + from<br />
}</p>

<p>const (<br />
&nbsp;&nbsp; &nbsp;// Standard length of uniuri string to achive ~95 bits of entropy.<br />
&nbsp;&nbsp; &nbsp;StdLen = 16<br />
&nbsp;&nbsp; &nbsp;// Length of uniurl string to achive ~119 bits of entropy, closest<br />
&nbsp;&nbsp; &nbsp;// to what can be losslessly converted to UUIDv4 (122 bits).<br />
&nbsp;&nbsp; &nbsp;UUIDLen = 20<br />
)</p>

<p>// Standard characters allowed in uniuri string.<br />
var StdChars = []byte(&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789&quot;)</p>

<p>// New returns a new random string of the standard length, consisting of<br />
// standard characters.<br />
func New() string {<br />
&nbsp;&nbsp; &nbsp;return NewLenChars(StdLen, StdChars)<br />
}</p>

<p>// NewLen returns a new random string of the provided length, consisting of<br />
// standard characters.<br />
func NewLen(length int) string {<br />
&nbsp;&nbsp; &nbsp;return NewLenChars(length, StdChars)<br />
}</p>

<p>// NewLenChars returns a new random string of the provided length, consisting<br />
// of the provided byte slice of allowed characters (maximum 256).<br />
func NewLenChars(length int, chars []byte) string {<br />
&nbsp;&nbsp; &nbsp;b := make([]byte, length)<br />
&nbsp;&nbsp; &nbsp;r := make([]byte, length+(length/4)) // storage for random bytes.<br />
&nbsp;&nbsp; &nbsp;clen := byte(len(chars))<br />
&nbsp;&nbsp; &nbsp;maxrb := byte(256 - (256 % len(chars)))<br />
&nbsp;&nbsp; &nbsp;i := 0<br />
&nbsp;&nbsp; &nbsp;for {<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;if _, err := io.ReadFull(crand.Reader, r); err != nil {<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;panic(&quot;error reading from random source: &quot; + err.Error())<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;for _, c := range r {<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;if c &gt;= maxrb {<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;// Skip this number to avoid modulo bias.<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;continue<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;b[i] = chars[c%clen]<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;i++<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;if i == length {<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;return string(b)<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br />
&nbsp;&nbsp; &nbsp;}<br />
&nbsp;&nbsp; &nbsp;panic(&quot;unreachable&quot;)<br />
}</p>

<p>func pic(w http.ResponseWriter, req *http.Request) {<br />
&nbsp;&nbsp; &nbsp;d := make([]byte, 4)<br />
&nbsp;&nbsp; &nbsp;s := NewLen(4)<br />
&nbsp;&nbsp; &nbsp;ss := &quot;&quot;<br />
&nbsp;&nbsp; &nbsp;d = []byte(s)<br />
&nbsp;&nbsp; &nbsp;for v := range d {<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;d[v] %= 10<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;ss += strconv.FormatInt(int64(d[v]), 32)<br />
&nbsp;&nbsp; &nbsp;}<br />
&nbsp;&nbsp; &nbsp;w.Header().Set(&quot;Content-Type&quot;, &quot;image/png&quot;)<br />
&nbsp;&nbsp; &nbsp;NewImage(d, 100, 40).WriteTo(w)<br />
&nbsp;&nbsp; &nbsp;fmt.Println(ss)<br />
}</p>

<p>func index(w http.ResponseWriter, req *http.Request) {<br />
&nbsp;&nbsp; &nbsp;str := &quot;&lt;meta charset=\&quot;utf-8\&quot;&gt;&lt;h3&gt;golang 图片验证码例子&lt;/h3&gt;&lt;img border=\&quot;1\&quot; src=\&quot;/pic\&quot; alt=\&quot;图片验证码\&quot; onclick=\&quot;this.src=&#39;/pic&#39;\&quot; /&gt;&quot;<br />
&nbsp;&nbsp; &nbsp;w.Header().Set(&quot;Content-Type&quot;, &quot;text/html&quot;)<br />
&nbsp;&nbsp; &nbsp;w.Write([]byte(str))<br />
}</p>

<p>func main() {<br />
&nbsp;&nbsp; &nbsp;http.HandleFunc(&quot;/pic&quot;, pic)<br />
&nbsp;&nbsp; &nbsp;http.HandleFunc(&quot;/&quot;, index)<br />
&nbsp;&nbsp; &nbsp;s := &amp;http.Server{<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;Addr: &nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; &nbsp;&quot;:8080&quot;,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;ReadTimeout: &nbsp;&nbsp; &nbsp;30*time.Second,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;WriteTimeout: &nbsp;&nbsp; &nbsp;30*time.Second,<br />
&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;MaxHeaderBytes: 1 &lt;&lt; 20,<br />
&nbsp;&nbsp; &nbsp;}<br />
&nbsp;&nbsp; &nbsp;s.ListenAndServe()<br />
}</p>
</div>
                     Tags: <a href="http://responsivewebinc.com/nannie/tag/condimen/" rel="tag">condimen</a> <a href="http://responsivewebinc.com/nannie/tag/lobor/" rel="tag">lobor</a>                  </div>
                  <div class="clearfix"></div>
               </div>
               
                

 
<div class="comments well">
<h3><span class="comment-heading">Comments - </span>0 Responses</h3>
 




</div>

<div class="navigation">
<div class="pull-left"><a href="/comment-page-1/#comments" >&laquo; Older Comments</a></div>
<div class="pull-right"></div>
</div>

<div class="clearfix"></div>

 
 
<div id="respond" class="respond well">
 
<h3><span>Leave a Reply</span></h3>
 
<div class="cancel-comment-reply">
<a rel="nofollow" id="cancel-comment-reply-link" href="#respond" style="display:none;">Cancel Reply</a></div>

<div class="clearfix"></div>
 

<form action="/view/12" method="post" id="commentform" class="form-horizontal">
      <div class="control-group">
         <label class="control-label" for="author">Name</label>
         <div class="controls">
            <input type="text" class="input-large" name="author" id="author" value="" required>
         </div>
      </div>  

      <div class="control-group">
         <label class="control-label" for="email">Email</label>
         <div class="controls">
            <input type="text" class="input-large" name="email" id="email" value="" required>
         </div>
      </div>

      <div class="control-group">
         <label class="control-label" for="website">Website</label>
         <div class="controls">
            <input type="text" class="input-large" name="website" id="website" value="" >
         </div>
      </div> 
	
 

 
      <div class="control-group">
         <label class="control-label" for="comment">Comment</label>
         <div class="controls">
            <textarea class="input-xlarge" name="comment" id="comment" rows="8" style="width:80%;"></textarea>
         </div>
      </div> 

      <div class="form-actions">
         <input name="submit" type="submit" id="comment-submit" tabindex="5" value="评论" class="btn" />
         <button type="reset" class="btn">清空</button>
      </div>
 
<p>
<input type='hidden' name='comment_userid' value='0' id='comment_userid' />
<input type='hidden' name='comment_parent' id='comment_parent' value='12' />
</p>

<div class="clear"></div>
</form>
 
</div>

            
   <div class="navigation">
      <div class="pull-left">&laquo; <a href="http://responsivewebinc.com/nannie/ut-consectetur-ultricies-consequat/" rel="prev">Ut consectetur ultricies consequat</a></div>
      <div class="pull-right"></div>
      <div class="clearfix"></div>
   </div>  
   <div class="clearfix"></div>
               
</div>
            

         </div>

         <div class="span4">
            
               <div class="sidebar">
<div class="widget">
  <h3><span>搜索</span></h3><div class="form">
  <form method="get" id="searchform" action="/search" class="form-search">
  <input type="text" value="" name="keyword" id="keyword" class="input-medium"/>
  <input type="submit" id="searchsubmit" value="搜索" class="btn"/>
  </form>
  </div>
</div>


<div class="widget">
  
  <h3><span>注册登录</span></h3>
  
  <ul>
  
     <li><a href="/register">注册</a></li>
     <li><a href="/login">登录</a></li>
  
  </ul>
</div>


<div class="widget">
  <h3><span>最新10个节点</span></h3>
  <ul>
  
    
      <li><a href="/node/4" title="golang">golang</a></li>
    
      <li><a href="/node/3" title="站长技巧">站长技巧</a></li>
    
      <li><a href="/node/2" title="编程笔记">编程笔记</a></li>
    
      <li><a href="/node/1" title="祭奠青春">祭奠青春</a></li>
    
  
  </ul>
</div>

<div class="widget">
  <h3><span>最新10条评论</span></h3>
  <ul id="recentcomments">
  
      
      <li class="recentcomments">ID:1 on <a href="/view/1#comment-2">失去了年华，容颜退却~</a></li>
      
  
  </ul>
</div>

<div class="widget">
  <h3><span>博客分类</span></h3>
  <ul>
    
      
        <li class="cat-item"><a href="/category/1">代码</a></li>
      
        <li class="cat-item"><a href="/category/2"> 笔记</a></li>
      
        <li class="cat-item"><a href="/category/3">文学</a></li>
      
    
  </ul>
</div>

             </div>
         </div>
      </div>
   </div>
</div>



<footer>
  <div class="container">
    <div class="row">
      
         <div class="span4">
                        <div class="fwidget">
               <h4>About Insion.Co</h4>
               <p>Insion.Co是基于toropress搭建的中文博客，欢迎大家收藏！</p>
            </div>
                     </div>
         <div class="span4">
                        <div class="fwidget">
               <h4>Recent Comments</h4>
               <ul>
                
                  
                  <li>ID:1 on <a href="/view/1#comment-2">失去了年华，容颜退却~</a></li>
                  
                
               </ul>
            </div>     
         </div>
         <div class="span4">
                        <div class="fwidget">
               <h4>Categories</h4>
               <ul>
                
                  
                    <li><a href="/category/1">代码</a></li>
                  
                    <li><a href="/category/2"> 笔记</a></li>
                  
                    <li><a href="/category/3">文学</a></li>
                  
                
               </ul>
            </div>   
                     </div>
      <div class="span12">
         <div class="copy">
            <p>Copyright &copy; 2013 - <a href="/">Insion Co.</a> Powered by <a href="https://github.com/insionng/toropress" target="_blank">ToroPress</a>. <script src="http://s25.cnzz.com/stat.php?id=5052969&web_id=5052969&online=1&show=line" language="JavaScript"></script>
            </p>
         </div>
      </div>
    </div>
  <div class="clearfix"></div>
  </div>
</footer>       


<script src="/static/js/jquery-1.8.2.js"></script>
<script src="/static/js/bootstrap.js"></script>
</body>
</html>